<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Focus Flow Calendar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
      --surface: #0b0b0f;
      --surface-alt: #15151f;
      --surface-weekend: rgba(34, 34, 48, 0.68);
      --weekend-accent: rgba(255, 255, 255, 0.08);
      --text: #f2f3f5;
      --muted: rgba(242, 243, 245, 0.65);
      --accent: #6a5acd;
      --accent-soft: rgba(106, 90, 205, 0.16);
      --grid-line: rgba(255, 255, 255, 0.06);
      --shadow: 0 24px 48px rgba(0, 0, 0, 0.25);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-sm: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top right, rgba(106, 90, 205, 0.12), transparent 45%),
                  radial-gradient(circle at bottom left, rgba(255, 105, 180, 0.18), transparent 55%),
                  var(--surface);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.4;
      padding: 40px clamp(24px, 5vw, 72px);
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: min(1200px, 100%);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .app-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }

    .app-header h1 {
      margin: 0;
      font-family: 'Space Grotesk', 'Inter', sans-serif;
      font-size: clamp(28px, 4vw, 44px);
      letter-spacing: -0.02em;
    }

    .tagline {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 15px;
      max-width: 420px;
    }

    .time-block {
      display: grid;
      gap: 6px;
      text-align: right;
      font-size: 15px;
      color: var(--muted);
      padding: 12px 18px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
    }

    .time-block .current-time {
      font-size: 20px;
      color: var(--text);
      font-weight: 600;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .month-nav {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
    }

    .month-nav button {
      appearance: none;
      border: none;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      font-size: 22px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .month-nav button:hover {
      transform: translateY(-1px) scale(1.05);
      background: rgba(106, 90, 205, 0.25);
    }

    .month-nav h2 {
      margin: 0;
      font-size: clamp(20px, 3vw, 28px);
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .control-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      appearance: none;
      border: none;
      padding: 12px 18px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 18px 30px rgba(106, 90, 205, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(106, 90, 205, 0.4);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .calendar-card {
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      position: relative;
      overflow: visible;
    }

    .weekday-row {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
      color: var(--muted);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    .weekday-row span.weekend {
      color: rgba(242, 243, 245, 0.5);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 10px;
      overflow: visible;
    }

    .day {
      position: relative;
      background: rgba(11, 11, 15, 0.6);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.05);
      min-height: 130px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1),
                  box-shadow 0.35s cubic-bezier(0.22, 1, 0.36, 1),
                  border 0.2s ease,
                  background 0.2s ease;
      overflow: visible;
      transform-origin: center;
      will-change: transform;
      z-index: 1;
    }

    .day.weekend {
      background: var(--surface-weekend);
      border-color: var(--weekend-accent);
    }

    .day.weekend::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.04), transparent 70%);
      opacity: 0.7;
      pointer-events: none;
    }

    .day.weekend .task-preview,
    .day.weekend .day-number {
      position: relative;
      z-index: 1;
    }

    .day::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: 0 0 0 0 rgba(106, 90, 205, 0.4);
      opacity: 0;
      transition: opacity 0.35s ease, box-shadow 0.35s ease;
      pointer-events: none;
    }

    .day:is(:hover, .drag-over, .flyout-hover) {
      transform: scale(1.08);
      border-color: rgba(255, 255, 255, 0.18);
      background: rgba(21, 21, 31, 0.82);
      z-index: 5;
      box-shadow: 0 28px 60px rgba(0, 0, 0, 0.45);
    }

    .day.weekend:is(:hover, .drag-over, .flyout-hover) {
      background: rgba(40, 40, 58, 0.92);
    }

    .day:is(:hover, .drag-over, .flyout-hover)::after {
      opacity: 1;
      box-shadow: 0 0 0 8px rgba(106, 90, 205, 0.18);
    }

    .day.empty {
      background: rgba(255, 255, 255, 0.02);
      border-style: dashed;
      border-color: rgba(255, 255, 255, 0.05);
    }

    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .day-number {
      font-weight: 700;
      font-size: 16px;
      letter-spacing: 0.06em;
    }

    .day-number .weekday {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
      letter-spacing: 0.15em;
      margin-top: 4px;
    }

    .add-task-btn {
      appearance: none;
      border: none;
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .add-task-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-height: 24px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.18) transparent;
    }

    .task-list::-webkit-scrollbar {
      width: 6px;
    }

    .task-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.18);
      border-radius: 999px;
    }

    .task-preview {
      display: grid;
      gap: 3px;
      min-height: 20px;
      pointer-events: none;
      grid-auto-rows: 4px;
      position: relative;
      z-index: 1;
    }

    .task-preview-bar {
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.14);
      position: relative;
      overflow: hidden;
    }

    .task-preview-bar::after {
      content: '';
      position: absolute;
      inset: 0;
      opacity: 0.9;
      background: inherit;
      box-shadow: 0 6px 10px rgba(0, 0, 0, 0.24);
    }

    .task-preview-bar.mission-critical {
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.55);
    }

    .task-preview-empty {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.35);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .task-flyout {
      position: absolute;
      top: calc(100% + 12px);
      left: 50%;
      transform: translate(-50%, -12px);
      width: clamp(260px, 32vw, 360px);
      max-height: clamp(220px, 52vh, 480px);
      padding: 18px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(21, 21, 31, 0.96);
      box-shadow: 0 32px 60px rgba(0, 0, 0, 0.48);
      backdrop-filter: blur(18px);
      opacity: 0;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 12;
    }

    .task-flyout .focus-flyout-section {
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .task-flyout .focus-flyout-section + .task-list {
      margin-top: 6px;
    }

    .day:is(:hover, .drag-over, .flyout-hover) .task-flyout {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, 0);
    }

    .task-flyout .task-list {
      max-height: clamp(220px, 52vh, 480px);
      overflow: auto;
      padding-right: 4px;
    }

    .task-flyout .empty-state {
      text-align: center;
      padding: 16px 0;
      color: rgba(255, 255, 255, 0.45);
    }

    .focus-range {
      border-color: rgba(106, 90, 205, 0.45);
      box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.35);
    }

    .focus-range::after {
      opacity: 1;
      box-shadow: 0 0 0 6px rgba(106, 90, 205, 0.18);
    }

    .focus-range .day-number {
      color: var(--accent);
    }

    .task-card {
      position: relative;
      background: rgba(255, 255, 255, 0.07);
      border-radius: var(--radius-sm);
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: grab;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease, border-color 0.2s ease;
      min-height: 34px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .task-card:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .task-card:active {
      cursor: grabbing;
      transform: scale(0.99);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.35);
    }

    .task-card.is-dragging {
      opacity: 0.6;
      transform: scale(0.97);
      box-shadow: 0 18px 32px rgba(0, 0, 0, 0.45);
    }

    .task-card.mission-critical {
      border-color: rgba(255, 255, 255, 0.55);
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.25);
    }

    .task-title {
      font-weight: 600;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .task-title .task-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .task-time {
      font-size: 12px;
      color: var(--muted);
      margin-left: auto;
    }

    .task-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.08);
    }

    .task-card.mission-critical .task-dot {
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.35);
    }

    .task-footer {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    .task-category-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .task-note-line {
      font-size: 12px;
      color: rgba(242, 243, 245, 0.75);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .day.today {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(106, 90, 205, 0.3);
    }

    .day.today .day-number {
      color: var(--accent);
    }

    .focus-overlay-stack {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: grid;
      align-content: stretch;
      gap: 6px;
      padding: 6px;
      z-index: 0;
    }

    .focus-overlay {
      border-radius: var(--radius-sm);
      background: rgba(255, 255, 255, 0.12);
      min-height: 12px;
      mix-blend-mode: screen;
    }

    .day-progress {
      position: absolute;
      left: 0;
      bottom: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), rgba(255, 105, 180, 0.9));
      border-radius: 0 4px 0 0;
      pointer-events: none;
    }
    .focus-flyout-section {
      display: grid;
      gap: 6px;
    }

    .focus-flyout-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .focus-flyout-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .focus-flyout-tag {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.07);
      color: var(--text);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .focus-flyout-tag:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    .focus-flyout-tag span {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-flex;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(8, 8, 12, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      width: min(420px, 100%);
      background: rgba(14, 14, 20, 0.95);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 24px;
      box-shadow: 0 28px 60px rgba(0, 0, 0, 0.4);
      display: grid;
      gap: 18px;
    }

    .modal h2 {
      margin: 0;
      font-size: 22px;
    }

    .modal form {
      display: grid;
      gap: 14px;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .field label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .field input,
    .field textarea,
    .field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }

    .field textarea {
      min-height: 80px;
      resize: vertical;
    }

    .checkbox-field {
      display: flex;
      align-items: center;
    }

    .checkbox-field label {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text);
    }

    .checkbox-field input[type='checkbox'] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .modal-actions .spacer {
      flex: 1;
    }

    .empty-state {
      color: var(--muted);
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div>
        <h1>Focus Flow Calendar</h1>
        <p class="tagline">Design a bold rhythm for your week. Sequence deep work, creative sprints, and essential tasks with intent.</p>
      </div>
      <div class="time-block">
        <span class="current-date"></span>
        <span class="current-time"></span>
      </div>
    </header>

    <section class="controls">
      <div class="month-nav">
        <button id="prev-month" aria-label="Previous month">&#x2039;</button>
        <h2 id="month-label"></h2>
        <button id="next-month" aria-label="Next month">&#x203A;</button>
      </div>
      <div class="control-buttons">
        <button class="btn btn-ghost" id="reset-calendar" title="Reset to today">Today</button>
        <button class="btn btn-primary" id="add-focus">+ Focus Block</button>
      </div>
    </section>

    <section class="calendar-card">
      <div class="weekday-row">
        <span>Mon</span>
        <span>Tue</span>
        <span>Wed</span>
        <span>Thu</span>
        <span>Fri</span>
        <span class="weekend">Sat</span>
        <span class="weekend">Sun</span>
      </div>
      <div class="calendar-grid" id="calendar-grid"></div>
    </section>
  </div>

  <div class="modal-backdrop" id="task-modal">
    <div class="modal">
      <h2 id="task-modal-title">Plan a task</h2>
      <form id="task-form">
        <div class="field">
          <label for="task-title">Task</label>
          <input type="text" id="task-title" name="title" placeholder="What will you tackle?" required>
        </div>
        <div class="field">
          <label for="task-category">Category</label>
          <input type="text" id="task-category" name="category" placeholder="Deep Work, Admin, Studio, ..." list="category-options" autocomplete="off">
          <datalist id="category-options"></datalist>
        </div>
        <div class="field">
          <label for="category-color">Category colour</label>
          <input type="color" id="category-color" name="categoryColor" value="#6a5acd">
        </div>
        <div class="checkbox-field">
          <label for="task-mission">
            <input type="checkbox" id="task-mission" name="mission">
            Mission Critical
          </label>
        </div>
        <div class="field">
          <label for="task-start">Start time</label>
          <input type="time" id="task-start" name="start">
        </div>
        <div class="field">
          <label for="task-duration">Time allocation (hours)</label>
          <input type="number" min="0" step="0.5" id="task-duration" name="duration" placeholder="2">
        </div>
        <div class="field">
          <label for="task-notes">Notes</label>
          <textarea id="task-notes" name="notes" placeholder="Context, deliverables or links..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="task-cancel">Cancel</button>
          <span class="spacer"></span>
          <button type="button" class="btn btn-ghost" id="task-delete" style="display:none;">Delete</button>
          <button type="submit" class="btn btn-primary">Save Task</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" id="focus-modal">
    <div class="modal">
      <h2 id="focus-modal-title">New focus block</h2>
      <form id="focus-form">
        <div class="field">
          <label for="focus-name">Project / Intention</label>
          <input type="text" id="focus-name" name="name" placeholder="Filming + editing ads" required>
        </div>
        <div class="field">
          <label for="focus-start">Start date</label>
          <input type="date" id="focus-start" name="start" required>
        </div>
        <div class="field">
          <label for="focus-end">Wrap date</label>
          <input type="date" id="focus-end" name="end" required>
        </div>
        <div class="field">
          <label for="focus-color">Colour</label>
          <input type="color" id="focus-color" name="color" value="#ff6f91">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="focus-cancel">Cancel</button>
          <span class="spacer"></span>
          <button type="button" class="btn btn-ghost" id="focus-delete" style="display:none;">Delete</button>
          <button type="submit" class="btn btn-primary">Save Focus</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const storageKey = 'focus-flow-calendar-state-v2';
    const legacyStorageKey = 'focus-flow-calendar-state-v1';

    const defaultState = () => ({
      tasks: {},
      projects: [],
      categories: {},
      nextTaskId: 1,
      nextProjectId: 1
    });

    function loadState() {
      try {
        let raw = localStorage.getItem(storageKey);
        let usingLegacy = false;
        if (!raw) {
          raw = localStorage.getItem(legacyStorageKey);
          usingLegacy = !!raw;
        }
        if (!raw) return defaultState();
        const parsed = JSON.parse(raw);
        if (!parsed.tasks) parsed.tasks = {};
        if (!parsed.projects) parsed.projects = [];
        if (!parsed.categories) parsed.categories = {};
        if (!parsed.nextTaskId) parsed.nextTaskId = 1;
        if (!parsed.nextProjectId) parsed.nextProjectId = 1;
        if (usingLegacy) {
          localStorage.setItem(storageKey, JSON.stringify(parsed));
          localStorage.removeItem(legacyStorageKey);
        }
        return parsed;
      } catch (err) {
        console.error('Failed to parse state', err);
        return defaultState();
      }
    }

    function saveState() {
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    function formatDateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseDateKey(key) {
      const [year, month, day] = key.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function formatFullDate(date) {
      return date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
    }

    function formatTime(date) {
      return date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }

    function compareTasks(a, b) {
      const timeA = a.start || '';
      const timeB = b.start || '';
      if (!timeA && timeB) return -1;
      if (timeA && !timeB) return 1;
      if (timeA && timeB && timeA !== timeB) {
        return timeA.localeCompare(timeB);
      }
      if (a.missionCritical && !b.missionCritical) return -1;
      if (!a.missionCritical && b.missionCritical) return 1;
      return a.title.localeCompare(b.title);
    }

    function hexToRgba(hex, alpha) {
      if (!hex || typeof hex !== 'string') return `rgba(255,255,255,${alpha})`;
      const stripped = hex.replace('#', '');
      const bigint = parseInt(stripped.length === 3
        ? stripped.split('').map((c) => c + c).join('')
        : stripped, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function hexToRgb(hex) {
      if (!hex || typeof hex !== 'string') {
        return { r: 106, g: 90, b: 205 };
      }
      let stripped = hex.replace('#', '');
      if (stripped.length === 3) {
        stripped = stripped.split('').map((c) => c + c).join('');
      }
      const bigint = parseInt(stripped, 16);
      return {
        r: (bigint >> 16) & 255,
        g: (bigint >> 8) & 255,
        b: bigint & 255
      };
    }

    function rgbToHex(r, g, b) {
      return `#${[r, g, b]
        .map((value) => Math.max(0, Math.min(255, value)))
        .map((value) => value.toString(16).padStart(2, '0'))
        .join('')}`;
    }

    function shadeColorByDuration(hex, duration) {
      const { r, g, b } = hexToRgb(hex);
      const hours = Math.max(0, Math.min(parseFloat(duration) || 0, 8));
      if (!hours) {
        return rgbToHex(r, g, b);
      }
      const multiplier = 0.55 + (1 - hours / 8) * 0.45;
      return rgbToHex(
        Math.round(r * multiplier),
        Math.round(g * multiplier),
        Math.round(b * multiplier)
      );
    }

    function getCategoryBaseColor(categoryName, fallback) {
      if (categoryName && state.categories[categoryName]) {
        return state.categories[categoryName].color;
      }
      if (fallback) return fallback;
      return '#6a5acd';
    }

    function getTaskColor(task) {
      const baseColor = getCategoryBaseColor(task.category, task.color);
      return shadeColorByDuration(baseColor, task.duration);
    }

    function getNotePreview(notes) {
      if (!notes) return '';
      const firstLine = notes.split(/\r?\n/).find((line) => line.trim().length) || '';
      return firstLine.trim();
    }

    const monthLabelEl = document.getElementById('month-label');
    const calendarGridEl = document.getElementById('calendar-grid');
    const currentDateEl = document.querySelector('.current-date');
    const currentTimeEl = document.querySelector('.current-time');

    const taskModalBackdrop = document.getElementById('task-modal');
    const taskForm = document.getElementById('task-form');
    const taskModalTitle = document.getElementById('task-modal-title');
    const taskDeleteBtn = document.getElementById('task-delete');
    const taskCancelBtn = document.getElementById('task-cancel');
    const categoryOptionsEl = document.getElementById('category-options');
    const taskTitleInput = document.getElementById('task-title');
    const taskCategoryInput = document.getElementById('task-category');
    const taskCategoryColorInput = document.getElementById('category-color');
    const taskMissionInput = document.getElementById('task-mission');
    const taskStartInput = document.getElementById('task-start');
    const taskDurationInput = document.getElementById('task-duration');
    const taskNotesInput = document.getElementById('task-notes');

    const focusModalBackdrop = document.getElementById('focus-modal');
    const focusForm = document.getElementById('focus-form');
    const focusModalTitle = document.getElementById('focus-modal-title');
    const focusDeleteBtn = document.getElementById('focus-delete');
    const focusCancelBtn = document.getElementById('focus-cancel');

    let state = loadState();
    let today = new Date();
    let viewYear = today.getFullYear();
    let viewMonth = today.getMonth();

    let editingTask = null;
    let editingDate = null;
    let editingFocusId = null;
    let draggedTask = null;
    let focusSelection = null;
    let focusSelectionPointerId = null;

    function populateCategoryOptions() {
      if (!categoryOptionsEl) return;
      categoryOptionsEl.innerHTML = '';
      const names = Object.keys(state.categories || {}).sort((a, b) => a.localeCompare(b));
      names.forEach((name) => {
        const option = document.createElement('option');
        option.value = name;
        categoryOptionsEl.appendChild(option);
      });
    }

    function syncCategoryColourFromSelection() {
      const name = taskCategoryInput.value.trim();
      if (name && state.categories[name]) {
        taskCategoryColorInput.value = state.categories[name].color;
      }
    }

    function setupFlyoutPersistence(cell, flyout) {
      let hideTimeout;

      const hold = () => {
        clearTimeout(hideTimeout);
        cell.classList.add('flyout-hover');
      };

      const release = () => {
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(() => {
          cell.classList.remove('flyout-hover');
        }, 120);
      };

      cell.addEventListener('mouseenter', hold);
      cell.addEventListener('mouseleave', release);
      flyout.addEventListener('mouseenter', hold);
      flyout.addEventListener('mouseleave', release);
    }

    function detachFocusPointerListeners() {
      window.removeEventListener('pointerup', handleFocusPointerUp);
      window.removeEventListener('pointercancel', handleFocusPointerCancel);
    }

    function clearFocusSelectionHighlights() {
      calendarGridEl.querySelectorAll('.day.focus-range').forEach((cell) => {
        cell.classList.remove('focus-range');
      });
    }

    function updateFocusSelectionHighlight() {
      clearFocusSelectionHighlights();
      if (!focusSelection) return;
      const { anchor, current } = focusSelection;
      const [startKey, endKey] = anchor <= current ? [anchor, current] : [current, anchor];
      const startDate = parseDateKey(startKey);
      const endDate = parseDateKey(endKey);
      const cursor = new Date(startDate);
      while (cursor <= endDate) {
        const key = formatDateKey(cursor);
        const cell = calendarGridEl.querySelector(`.day[data-date="${key}"]`);
        if (cell) {
          cell.classList.add('focus-range');
        }
        cursor.setDate(cursor.getDate() + 1);
      }
    }

    function clearFocusSelection() {
      clearFocusSelectionHighlights();
      focusSelection = null;
      focusSelectionPointerId = null;
      detachFocusPointerListeners();
    }

    function finalizeFocusSelection() {
      if (!focusSelection) return;
      const { anchor, current } = focusSelection;
      const [startKey, endKey] = anchor <= current ? [anchor, current] : [current, anchor];
      clearFocusSelection();
      openFocusModal(null, { start: startKey, end: endKey });
    }

    function handleFocusPointerUp(event) {
      if (!focusSelection) {
        detachFocusPointerListeners();
        return;
      }
      if (focusSelectionPointerId != null && event.pointerId !== focusSelectionPointerId) {
        return;
      }
      finalizeFocusSelection();
    }

    function handleFocusPointerCancel() {
      clearFocusSelection();
    }

    function startFocusSelection(dateKey, pointerId) {
      clearFocusSelection();
      focusSelection = { anchor: dateKey, current: dateKey };
      focusSelectionPointerId = pointerId;
      updateFocusSelectionHighlight();
      window.addEventListener('pointerup', handleFocusPointerUp);
      window.addEventListener('pointercancel', handleFocusPointerCancel);
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && focusSelection) {
        clearFocusSelection();
      }
    });

    function clearDragState() {
      draggedTask = null;
      document.querySelectorAll('.drag-over').forEach((day) => day.classList.remove('drag-over'));
      document.querySelectorAll('.task-card.is-dragging').forEach((card) => card.classList.remove('is-dragging'));
    }

    function openTaskModal(dateKey, task) {
      editingDate = dateKey;
      editingTask = task ? { ...task } : null;
      taskModalBackdrop.classList.add('open');
      taskModalTitle.textContent = task ? 'Update task' : 'Plan a task';
      taskDeleteBtn.style.display = task ? 'inline-flex' : 'none';

      taskForm.reset();
      populateCategoryOptions();

      const categoryName = task?.category || '';

      taskTitleInput.value = task ? task.title : '';
      taskCategoryInput.value = categoryName;
      taskMissionInput.checked = Boolean(task?.missionCritical);
      taskStartInput.value = task?.start || '';
      taskDurationInput.value = task?.duration != null ? String(task.duration) : '';
      taskNotesInput.value = task?.notes || '';

      let categoryColour = getCategoryBaseColor(categoryName, task?.color);
      if (task?.color && (!categoryName || !state.categories[categoryName])) {
        categoryColour = task.color;
      }
      taskCategoryColorInput.value = categoryColour;
      syncCategoryColourFromSelection();
    }

    function closeTaskModal() {
      taskModalBackdrop.classList.remove('open');
      editingTask = null;
      editingDate = null;
      draggedTask = null;
    }

    function openFocusModal(project, options = {}) {
      editingFocusId = project ? project.id : null;
      focusModalBackdrop.classList.add('open');
      focusModalTitle.textContent = project ? 'Update focus block' : 'New focus block';
      focusDeleteBtn.style.display = project ? 'inline-flex' : 'none';

      focusForm.reset();
      const colorField = document.getElementById('focus-color');
      const nameField = document.getElementById('focus-name');
      const startField = document.getElementById('focus-start');
      const endField = document.getElementById('focus-end');

      colorField.value = project?.color || options.color || '#ff6f91';
      if (project) {
        nameField.value = project.name;
        startField.value = project.start;
        endField.value = project.end;
      } else {
        if (options.name) nameField.value = options.name;
        const defaultDate = formatDateKey(today);
        const startValue = options.start || defaultDate;
        const endValue = options.end || options.start || defaultDate;
        startField.value = startValue;
        endField.value = endValue;
      }
    }

    function closeFocusModal() {
      focusModalBackdrop.classList.remove('open');
      editingFocusId = null;
    }

    function ensureTasks(dateKey) {
      if (!state.tasks[dateKey]) state.tasks[dateKey] = [];
      return state.tasks[dateKey];
    }

    function removeEmptyTaskLists(dateKey) {
      if (state.tasks[dateKey] && state.tasks[dateKey].length === 0) {
        delete state.tasks[dateKey];
      }
    }

    function renderCalendar() {
      clearDragState();

      monthLabelEl.textContent = new Date(viewYear, viewMonth, 1).toLocaleDateString(undefined, {
        month: 'long',
        year: 'numeric'
      });

      calendarGridEl.innerHTML = '';
      const firstDay = new Date(viewYear, viewMonth, 1);
      const startWeekday = (firstDay.getDay() + 6) % 7;
      const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
      const totalCells = Math.ceil((startWeekday + daysInMonth) / 7) * 7;
      const realTodayKey = formatDateKey(new Date());

      for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement('div');
        cell.className = 'day';

        const dayNumber = i - startWeekday + 1;
        if (dayNumber < 1 || dayNumber > daysInMonth) {
          cell.classList.add('empty');
          calendarGridEl.appendChild(cell);
          continue;
        }

        const date = new Date(viewYear, viewMonth, dayNumber);
        const dateKey = formatDateKey(date);
        cell.dataset.date = dateKey;

        const dayOfWeek = date.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          cell.classList.add('weekend');
        }

        if (realTodayKey === dateKey) {
          cell.classList.add('today');
        }

        cell.addEventListener('pointerdown', (event) => {
          if (event.button !== 0 || !event.shiftKey) return;
          if (event.target.closest('.task-card') || event.target.closest('.task-flyout') || event.target.closest('.add-task-btn') || event.target.closest('.focus-flyout-tag')) {
            return;
          }
          event.preventDefault();
          startFocusSelection(dateKey, event.pointerId);
        });

        cell.addEventListener('pointerenter', () => {
          if (!focusSelection) return;
          focusSelection.current = dateKey;
          updateFocusSelectionHighlight();
        });

          cell.addEventListener('dragenter', (event) => {
            event.preventDefault();
            cell.classList.add('drag-over');
          });

          cell.addEventListener('dragover', (event) => {
            event.preventDefault();
            cell.classList.add('drag-over');
            event.dataTransfer.dropEffect = 'move';
          });

          cell.addEventListener('dragleave', () => {
            cell.classList.remove('drag-over');
          });

          cell.addEventListener('drop', () => {
            cell.classList.remove('drag-over');
            if (!draggedTask) {
              clearDragState();
              return;
            }
            moveTaskToDate(draggedTask, dateKey);
            clearDragState();
          });

        const header = document.createElement('div');
        header.className = 'day-header';
        const numberEl = document.createElement('div');
        numberEl.className = 'day-number';
        numberEl.textContent = dayNumber;
        header.appendChild(numberEl);

        const addBtn = document.createElement('button');
        addBtn.className = 'add-task-btn';
        addBtn.type = 'button';
        addBtn.textContent = '+';
        addBtn.title = 'Add task';
        addBtn.addEventListener('click', () => openTaskModal(dateKey));
        header.appendChild(addBtn);

        cell.appendChild(header);

        const overlayStack = document.createElement('div');
        overlayStack.className = 'focus-overlay-stack';

        const activeProjects = state.projects.filter((project) => project.start <= dateKey && project.end >= dateKey);
        activeProjects.forEach((project) => {
          const overlay = document.createElement('div');
          overlay.className = 'focus-overlay';
          overlay.style.background = hexToRgba(project.color, 0.18);
          overlayStack.appendChild(overlay);
        });

        cell.appendChild(overlayStack);

        const taskList = document.createElement('div');
        taskList.className = 'task-list';
        const preview = document.createElement('div');
        preview.className = 'task-preview';
        const tasks = (state.tasks[dateKey] || []).slice().sort(compareTasks);
        tasks.forEach((task) => {
          const taskCard = document.createElement('div');
          taskCard.className = 'task-card';
          if (task.missionCritical) {
            taskCard.classList.add('mission-critical');
          }
          taskCard.draggable = true;
          taskCard.dataset.taskId = task.id;

          const taskColor = getTaskColor(task);
          taskCard.style.background = hexToRgba(taskColor, 0.18);

          const previewBar = document.createElement('div');
          previewBar.className = 'task-preview-bar';
          previewBar.style.background = hexToRgba(taskColor, 0.9);
          if (task.missionCritical) {
            previewBar.classList.add('mission-critical');
          }
          preview.appendChild(previewBar);

          taskCard.addEventListener('dragstart', (event) => {
            draggedTask = { id: task.id, fromDate: dateKey };
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', String(task.id));
            taskCard.classList.add('is-dragging');
          });

          taskCard.addEventListener('dragend', () => {
            clearDragState();
          });

          taskCard.addEventListener('dblclick', () => {
            openTaskModal(dateKey, task);
          });

          const title = document.createElement('div');
          title.className = 'task-title';

          const colorDot = document.createElement('span');
          colorDot.className = 'task-dot';
          colorDot.style.background = taskColor;
          title.appendChild(colorDot);

          const name = document.createElement('span');
          name.className = 'task-name';
          name.textContent = task.title;
          title.appendChild(name);

          let timeRange = '';
          if (task.start) {
            const endTime = task.duration ? computeEndTime(task.start, task.duration) : null;
            timeRange = endTime ? `${task.start} - ${endTime}` : task.start;
          }

          if (timeRange) {
            const timeEl = document.createElement('span');
            timeEl.className = 'task-time';
            timeEl.textContent = timeRange;
            title.appendChild(timeEl);
          }

          taskCard.appendChild(title);

          const footer = document.createElement('div');
          footer.className = 'task-footer';

          const categoryLabel = document.createElement('div');
          categoryLabel.className = 'task-category-label';
          categoryLabel.textContent = task.category || 'Uncategorised';
          footer.appendChild(categoryLabel);

          const notePreview = getNotePreview(task.notes);
          if (notePreview) {
            const noteLine = document.createElement('div');
            noteLine.className = 'task-note-line';
            noteLine.textContent = notePreview;
            footer.appendChild(noteLine);
          }

          taskCard.appendChild(footer);
          taskList.appendChild(taskCard);
        });

        if (!tasks.length) {
          const previewEmpty = document.createElement('div');
          previewEmpty.className = 'task-preview-empty';
          previewEmpty.textContent = 'No tasks yet';
          preview.appendChild(previewEmpty);

          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent = 'Drop tasks here';
          taskList.appendChild(empty);
        }

        const flyout = document.createElement('div');
        flyout.className = 'task-flyout';

        if (activeProjects.length) {
          const focusSection = document.createElement('div');
          focusSection.className = 'focus-flyout-section';

          const focusTitle = document.createElement('div');
          focusTitle.className = 'focus-flyout-title';
          focusTitle.textContent = activeProjects.length > 1 ? 'Focus blocks' : 'Focus block';
          focusSection.appendChild(focusTitle);

          const focusTags = document.createElement('div');
          focusTags.className = 'focus-flyout-tags';

          activeProjects.forEach((project) => {
            const tagButton = document.createElement('button');
            tagButton.type = 'button';
            tagButton.className = 'focus-flyout-tag';
            tagButton.style.background = hexToRgba(project.color, 0.16);
            tagButton.style.borderColor = hexToRgba(project.color, 0.35);
            const dot = document.createElement('span');
            dot.style.background = project.color;
            tagButton.appendChild(dot);
            tagButton.append(project.name);
            tagButton.addEventListener('click', (event) => {
              event.stopPropagation();
              openFocusModal(project);
            });
            focusTags.appendChild(tagButton);
          });

          focusSection.appendChild(focusTags);
          flyout.appendChild(focusSection);
        }

        flyout.appendChild(taskList);

        cell.appendChild(preview);
        cell.appendChild(flyout);
        setupFlyoutPersistence(cell, flyout);

        if (realTodayKey === dateKey) {
          const progress = document.createElement('div');
          progress.className = 'day-progress';
          cell.appendChild(progress);
        }

        calendarGridEl.appendChild(cell);
      }

      updateCurrentTime();
      updateFocusSelectionHighlight();
    }

    function computeEndTime(start, duration) {
      const [hours, minutes] = start.split(':').map(Number);
      const totalMinutes = hours * 60 + minutes + Math.round(Number(duration || 0) * 60);
      const endHours = Math.floor(totalMinutes / 60) % 24;
      const endMinutes = totalMinutes % 60;
      return `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
    }

    function moveTaskToDate(taskInfo, newDateKey) {
      const fromTasks = state.tasks[taskInfo.fromDate] || [];
      const taskIndex = fromTasks.findIndex((t) => t.id === taskInfo.id);
      if (taskIndex === -1) return;

      const [task] = fromTasks.splice(taskIndex, 1);
      if (!state.tasks[newDateKey]) state.tasks[newDateKey] = [];
      state.tasks[newDateKey].push(task);

      if (fromTasks.length === 0) {
        delete state.tasks[taskInfo.fromDate];
      }

      state.tasks[newDateKey].sort(compareTasks);
      saveState();
      renderCalendar();
    }

    document.getElementById('prev-month').addEventListener('click', () => {
      if (viewMonth === 0) {
        viewMonth = 11;
        viewYear -= 1;
      } else {
        viewMonth -= 1;
      }
      renderCalendar();
    });

    document.getElementById('next-month').addEventListener('click', () => {
      if (viewMonth === 11) {
        viewMonth = 0;
        viewYear += 1;
      } else {
        viewMonth += 1;
      }
      renderCalendar();
    });

    document.getElementById('reset-calendar').addEventListener('click', () => {
      today = new Date();
      viewYear = today.getFullYear();
      viewMonth = today.getMonth();
      renderCalendar();
    });

    document.getElementById('add-focus').addEventListener('click', () => {
      openFocusModal(null);
    });

    taskCancelBtn.addEventListener('click', closeTaskModal);
    focusCancelBtn.addEventListener('click', closeFocusModal);

    taskModalBackdrop.addEventListener('click', (event) => {
      if (event.target === taskModalBackdrop) {
        closeTaskModal();
      }
    });

    focusModalBackdrop.addEventListener('click', (event) => {
      if (event.target === focusModalBackdrop) {
        closeFocusModal();
      }
    });

    taskCategoryInput.addEventListener('input', syncCategoryColourFromSelection);
    taskCategoryInput.addEventListener('change', syncCategoryColourFromSelection);
    taskCategoryInput.addEventListener('blur', syncCategoryColourFromSelection);

    taskForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const title = taskTitleInput.value.trim();
      if (!title) return;

      const categoryName = taskCategoryInput.value.trim();
      const categoryColour = taskCategoryColorInput.value || '#6a5acd';
      const startValue = taskStartInput.value;
      const durationValue = taskDurationInput.value;
      const notesValue = taskNotesInput.value.trim();
      const missionCritical = taskMissionInput.checked;

      let durationNumber = null;
      if (durationValue !== '') {
        const parsedDuration = parseFloat(durationValue);
        if (!Number.isNaN(parsedDuration)) {
          durationNumber = parsedDuration;
        }
      }

      if (categoryName) {
        state.categories[categoryName] = { color: categoryColour };
      }

      if (editingTask) {
        const tasks = ensureTasks(editingDate);
        const index = tasks.findIndex((task) => task.id === editingTask.id);
        if (index !== -1) {
          const target = tasks[index];
          target.title = title;
          target.missionCritical = missionCritical;
          if (categoryName) {
            target.category = categoryName;
          } else {
            delete target.category;
          }
          if (startValue) {
            target.start = startValue;
          } else {
            delete target.start;
          }
          if (durationNumber != null) {
            target.duration = durationNumber;
          } else {
            delete target.duration;
          }
          if (notesValue) {
            target.notes = notesValue;
          } else {
            delete target.notes;
          }
        }
      } else {
        const taskId = state.nextTaskId++;
        const newTask = { id: taskId, title, missionCritical };
        if (categoryName) newTask.category = categoryName;
        if (startValue) newTask.start = startValue;
        if (durationNumber != null) newTask.duration = durationNumber;
        if (notesValue) newTask.notes = notesValue;
        ensureTasks(editingDate).push(newTask);
      }

      ensureTasks(editingDate).sort(compareTasks);
      saveState();
      closeTaskModal();
      populateCategoryOptions();
      renderCalendar();
    });

    taskDeleteBtn.addEventListener('click', () => {
      if (!editingTask) return;
      const tasks = ensureTasks(editingDate);
      const index = tasks.findIndex((task) => task.id === editingTask.id);
      if (index !== -1) {
        tasks.splice(index, 1);
      }
      removeEmptyTaskLists(editingDate);
      saveState();
      closeTaskModal();
      renderCalendar();
    });

    focusForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const formData = new FormData(focusForm);
      const name = formData.get('name').trim();
      const start = formData.get('start');
      const end = formData.get('end');
      if (!name || !start || !end) return;

      if (end < start) {
        alert('The wrap date must be on or after the start date.');
        return;
      }

      const color = formData.get('color');

      if (editingFocusId != null) {
        const index = state.projects.findIndex((project) => project.id === editingFocusId);
        if (index !== -1) {
          state.projects[index] = { ...state.projects[index], name, start, end, color };
        }
      } else {
        const project = {
          id: state.nextProjectId++,
          name,
          start,
          end,
          color
        };
        state.projects.push(project);
      }

      saveState();
      closeFocusModal();
      renderCalendar();
    });

    focusDeleteBtn.addEventListener('click', () => {
      if (editingFocusId == null) return;
      const index = state.projects.findIndex((project) => project.id === editingFocusId);
      if (index !== -1) {
        state.projects.splice(index, 1);
      }
      saveState();
      closeFocusModal();
      renderCalendar();
    });

    function updateCurrentTime() {
      const now = new Date();
      currentDateEl.textContent = formatFullDate(now);
      currentTimeEl.textContent = formatTime(now);

      const todayKey = formatDateKey(now);
      const todayCell = calendarGridEl.querySelector(`.day[data-date="${todayKey}"]`);
      if (todayCell) {
        todayCell.classList.add('today');
        const progress = todayCell.querySelector('.day-progress');
        if (progress) {
          const minutes = now.getHours() * 60 + now.getMinutes();
          const percentage = Math.min(100, Math.max(0, (minutes / (24 * 60)) * 100));
          progress.style.width = `${percentage}%`;
        }
      }
    }

    setInterval(updateCurrentTime, 60 * 1000);

    populateCategoryOptions();
    renderCalendar();
  </script>
  <!-- test commit -->
</body>
</html>
