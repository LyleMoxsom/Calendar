<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Focus Flow Calendar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light dark;
      --surface: #0b0b0f;
      --surface-alt: #15151f;
      --text: #f2f3f5;
      --muted: rgba(242, 243, 245, 0.65);
      --accent: #6a5acd;
      --accent-soft: rgba(106, 90, 205, 0.16);
      --grid-line: rgba(255, 255, 255, 0.06);
      --shadow: 0 24px 48px rgba(0, 0, 0, 0.25);
      --radius-lg: 22px;
      --radius-md: 16px;
      --radius-sm: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top right, rgba(106, 90, 205, 0.12), transparent 45%),
                  radial-gradient(circle at bottom left, rgba(255, 105, 180, 0.18), transparent 55%),
                  var(--surface);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.4;
      padding: 40px clamp(24px, 5vw, 72px);
      display: flex;
      justify-content: flex-start;
    }

    .app-shell {
      width: min(1400px, 100%);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .app-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }

    .app-header h1 {
      margin: 0;
      font-family: 'Space Grotesk', 'Inter', sans-serif;
      font-size: clamp(28px, 4vw, 44px);
      letter-spacing: -0.02em;
    }

    .tagline {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 15px;
      max-width: 420px;
    }

    .time-block {
      display: grid;
      gap: 6px;
      text-align: right;
      font-size: 15px;
      color: var(--muted);
      padding: 12px 18px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
    }

    .time-block .current-time {
      font-size: 20px;
      color: var(--text);
      font-weight: 600;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
      gap: 16px;
    }

    .control-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      appearance: none;
      border: none;
      padding: 12px 18px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
      box-shadow: 0 18px 30px rgba(106, 90, 205, 0.35);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(106, 90, 205, 0.4);
    }

    .btn-ghost {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-ghost:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .calendar-card {
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(18px);
      position: relative;
      overflow: visible;
    }

    .calendar-scroll {
      display: flex;
      flex-direction: column;
      gap: 56px;
      position: relative;
    }

    .calendar-layout {
      display: flex;
      gap: 28px;
      align-items: flex-start;
    }

    .main-calendar {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
    }

    .calendar-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
    }

    .calendar-toolbar .year-label {
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .btn-icon {
      padding: 10px;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      justify-content: center;
    }

    .btn-icon svg {
      width: 14px;
      height: 14px;
    }

    .year-view-card {
      flex: 0 0 clamp(260px, 26vw, 320px);
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: sticky;
      top: clamp(24px, 6vh, 56px);
      max-height: calc(100vh - clamp(48px, 10vh, 120px));
      overflow: hidden;
    }

    .year-view-scroll {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow-y: auto;
      padding-right: 6px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
    }

    .year-view-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .year-view-scroll::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.24);
      border-radius: 999px;
    }

    .mini-month {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mini-month-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(255, 255, 255, 0.55);
    }

    .mini-month-header .mini-year {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.38);
      letter-spacing: 0.14em;
    }

    .mini-weekday-row {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(255, 255, 255, 0.32);
    }

    .mini-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
    }

    .mini-day {
      position: relative;
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      overflow: hidden;
      isolation: isolate;
    }

    .mini-day-number {
      position: relative;
      z-index: 3;
    }

    .mini-day.weekend {
      background: rgba(255, 255, 255, 0.08);
    }

    .mini-day.empty {
      background: transparent;
      border-color: transparent;
      color: transparent;
    }

    .mini-day.today {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(106, 90, 205, 0.45);
      color: var(--accent);
      font-weight: 600;
    }

    .mini-focus-stack {
      position: absolute;
      inset: 3px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      pointer-events: none;
      z-index: 2;
    }

    .mini-focus-block {
      flex: 1;
      border-radius: 8px;
      border: 1px solid var(--mini-focus-border, rgba(255, 255, 255, 0.14));
      background:
        linear-gradient(135deg, var(--mini-focus-strong, rgba(255, 255, 255, 0.12)), var(--mini-focus-soft, rgba(255, 255, 255, 0.04)));
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.28);
      opacity: 0.9;
      transition: transform 0.2s ease, opacity 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      pointer-events: auto;
      position: relative;
      overflow: hidden;
    }

    .mini-focus-block:hover,
    .mini-focus-block:focus-visible {
      opacity: 1;
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(0, 0, 0, 0.35);
      border-color: var(--mini-focus-border, rgba(255, 255, 255, 0.28));
      outline: none;
    }

    .mini-day.focus-range {
      border-color: rgba(106, 90, 205, 0.45);
      box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.35);
    }

    @media (max-width: 1180px) {
      .calendar-layout {
        flex-direction: column;
      }

      .year-view-card {
        position: static;
        max-height: none;
        width: 100%;
      }

      .year-view-scroll {
        max-height: none;
      }
    }

    .month-block {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .month-divider {
      position: relative;
      height: 36px;
      display: flex;
      align-items: flex-end;
      margin-bottom: 8px;
    }

    .month-divider::before {
      content: '';
      position: absolute;
      left: -36px;
      right: -36px;
      bottom: 10px;
      height: 2px;
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 0 18px rgba(255, 255, 255, 0.55);
    }

    .month-block:first-of-type .month-divider::before {
      box-shadow: 0 0 14px rgba(255, 255, 255, 0.35);
    }

    .month-label {
      position: absolute;
      left: 0;
      top: -8px;
      font-family: 'Space Grotesk', 'Inter', sans-serif;
      font-size: clamp(26px, 6vw, 48px);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.28em;
      color: rgba(255, 255, 255, 0.1);
      pointer-events: none;
    }

    .month-tag {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(6px);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text);
      z-index: 1;
    }

    .weekday-row {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 12px;
      color: var(--muted);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    .weekday-row span.weekend {
      color: rgba(255, 255, 255, 0.55);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 10px;
      overflow: visible;
    }

    .day {
      position: relative;
      background: rgba(11, 11, 15, 0.6);
      border-radius: var(--radius-md);
      border: 1px solid rgba(255, 255, 255, 0.05);
      min-height: 130px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1),
                  box-shadow 0.35s cubic-bezier(0.22, 1, 0.36, 1),
                  border 0.2s ease,
                  background 0.2s ease;
      overflow: visible;
      transform-origin: center;
      will-change: transform;
      z-index: 1;
    }

    .day::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      box-shadow: 0 0 0 0 rgba(106, 90, 205, 0.4);
      opacity: 0;
      transition: opacity 0.35s ease, box-shadow 0.35s ease;
      pointer-events: none;
    }

    .day:is(:hover, .drag-over, .show-flyout) {
      transform: scale(1.08);
      border-color: rgba(255, 255, 255, 0.18);
      background: rgba(21, 21, 31, 0.82);
      z-index: 5;
      box-shadow: 0 28px 60px rgba(0, 0, 0, 0.45);
    }

    .day:is(:hover, .drag-over, .show-flyout)::after {
      opacity: 1;
      box-shadow: 0 0 0 8px rgba(106, 90, 205, 0.18);
    }

    .day.empty {
      background: rgba(255, 255, 255, 0.02);
      border-style: dashed;
      border-color: rgba(255, 255, 255, 0.05);
    }

    .day.weekend {
      background: rgba(21, 21, 31, 0.6);
    }

    .day.weekend.empty {
      background: rgba(255, 255, 255, 0.04);
    }

    .day.weekend:is(:hover, .drag-over, .show-flyout) {
      background: rgba(27, 27, 39, 0.88);
    }

    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .day-number {
      font-weight: 700;
      font-size: 16px;
      letter-spacing: 0.06em;
    }

    .day-number .weekday {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
      letter-spacing: 0.15em;
      margin-top: 4px;
    }

    .add-task-btn {
      appearance: none;
      border: none;
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .add-task-btn:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-height: 24px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.18) transparent;
    }

    .task-list::-webkit-scrollbar {
      width: 6px;
    }

    .task-list::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.18);
      border-radius: 999px;
    }

    .task-preview {
      display: grid;
      gap: 4px;
      min-height: 32px;
      pointer-events: none;
    }

    .task-preview-bar {
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.14);
      position: relative;
      overflow: hidden;
    }

    .task-preview-bar.mission-critical {
      box-shadow: 0 0 0 2px rgba(255, 196, 0, 0.5),
                  0 0 12px rgba(255, 196, 0, 0.3);
    }

    .task-preview-bar::after {
      content: '';
      position: absolute;
      inset: 0;
      opacity: 0.9;
      background: inherit;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.28);
    }

    .task-preview-empty {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.35);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .task-flyout {
      position: absolute;
      top: calc(100% + 12px);
      left: 50%;
      transform: translate(-50%, -12px);
      width: clamp(260px, 32vw, 360px);
      max-height: clamp(220px, 52vh, 480px);
      padding: 20px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(18, 18, 28, 0.96);
      box-shadow: 0 36px 72px rgba(0, 0, 0, 0.52);
      backdrop-filter: blur(20px);
      opacity: 0;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 40;
    }

    .day:is(:hover, .drag-over, .show-flyout) .task-flyout {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, 0);
    }

    .task-flyout .task-list {
      max-height: clamp(220px, 52vh, 480px);
      overflow: auto;
      padding-right: 4px;
    }

    .task-flyout .empty-state {
      text-align: center;
      padding: 16px 0;
      color: rgba(255, 255, 255, 0.45);
    }

    .focus-range {
      border-color: rgba(106, 90, 205, 0.45);
      box-shadow: 0 0 0 2px rgba(106, 90, 205, 0.35);
    }

    .focus-range::after {
      opacity: 1;
      box-shadow: 0 0 0 6px rgba(106, 90, 205, 0.18);
    }

    .focus-range .day-number {
      color: var(--accent);
    }

    .task-card {
      position: relative;
      background:
        linear-gradient(135deg, var(--task-tint-strong, rgba(255, 255, 255, 0.16)), var(--task-tint-soft, rgba(255, 255, 255, 0.05))),
        rgba(15, 15, 24, 0.78);
      border-radius: 18px;
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      cursor: grab;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background 0.2s ease;
      min-height: 52px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 22px 40px rgba(0, 0, 0, 0.42);
      overflow: hidden;
    }

    .task-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(150deg, rgba(255, 255, 255, 0.1), transparent);
      opacity: 0.7;
      pointer-events: none;
    }

    .task-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 4px;
      background: var(--task-outline, rgba(255, 255, 255, 0.24));
      opacity: 0.85;
      pointer-events: none;
    }

    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 28px 50px rgba(0, 0, 0, 0.5);
      border-color: var(--task-outline, rgba(255, 255, 255, 0.24));
      background:
        linear-gradient(135deg, var(--task-tint-strong, rgba(255, 255, 255, 0.2)), var(--task-tint-soft, rgba(255, 255, 255, 0.08))),
        rgba(18, 18, 28, 0.88);
    }

    .task-card:active {
      cursor: grabbing;
      transform: scale(0.99);
      box-shadow: 0 18px 32px rgba(0, 0, 0, 0.45);
    }

    .task-card.is-dragging {
      opacity: 0.65;
      transform: scale(0.97);
      box-shadow: 0 22px 38px rgba(0, 0, 0, 0.5);
    }

    .task-card.mission-critical {
      border-color: rgba(255, 214, 64, 0.85);
      box-shadow: 0 0 0 1px rgba(255, 196, 0, 0.45),
                  0 26px 46px rgba(255, 196, 0, 0.18);
    }

    .task-title {
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: nowrap;
      position: relative;
      z-index: 1;
    }

    .task-title .task-name {
      flex: 1 1 auto;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      letter-spacing: 0.01em;
    }

    .task-time {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.68);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-left: auto;
    }

    .task-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
      background: var(--task-dot, rgba(255, 255, 255, 0.65));
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.12);
    }

    .task-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.68);
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .task-detail-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .task-detail {
      display: inline-flex;
      align-items: center;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: rgba(255, 255, 255, 0.6);
    }

    .task-detail:not(:first-child)::before {
      content: '•';
      margin-right: 8px;
      color: rgba(255, 255, 255, 0.35);
    }

    .task-detail.mission-critical {
      color: rgba(255, 214, 64, 0.92);
      text-shadow: 0 0 12px rgba(255, 214, 64, 0.35);
    }

    .task-note-line {
      max-width: 100%;
      white-space: normal;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.45;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.78);
    }

    .day.today {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(106, 90, 205, 0.3);
    }

    .day.today .day-number {
      color: var(--accent);
    }

    .focus-overlay-stack {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: grid;
      align-content: stretch;
      gap: 6px;
      padding: 6px;
    }

    .focus-overlay {
      border-radius: var(--radius-sm);
      background: rgba(255, 255, 255, 0.12);
      min-height: 12px;
      mix-blend-mode: screen;
    }

    .focus-badges {
      display: none;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      font-size: 11px;
      letter-spacing: 0.08em;
    }

    .focus-badges.active {
      display: flex;
    }

    .focus-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      border-radius: 999px;
      background:
        linear-gradient(135deg, rgba(255, 255, 255, 0.18), rgba(255, 255, 255, 0.04));
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
      box-shadow: 0 20px 36px rgba(0, 0, 0, 0.4);
    }

    .focus-badge:hover,
    .focus-badge:focus-visible {
      background:
        linear-gradient(135deg, rgba(255, 255, 255, 0.28), rgba(255, 255, 255, 0.08));
      color: var(--text);
      transform: translateY(-1px);
      box-shadow: 0 26px 44px rgba(0, 0, 0, 0.48);
      outline: none;
    }

    .focus-badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-flex;
      box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.14);
    }

    .day-progress {
      position: absolute;
      left: 0;
      bottom: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), rgba(255, 105, 180, 0.9));
      border-radius: 0 4px 0 0;
      pointer-events: none;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(8, 8, 12, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
    }

    .modal-backdrop.open {
      display: flex;
    }

    .modal {
      width: min(420px, 100%);
      background: rgba(14, 14, 20, 0.95);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 24px;
      box-shadow: 0 28px 60px rgba(0, 0, 0, 0.4);
      display: grid;
      gap: 18px;
    }

    .modal h2 {
      margin: 0;
      font-size: 22px;
    }

    .modal form {
      display: grid;
      gap: 14px;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .field label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .field input,
    .field textarea,
    .field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
    }

    .field textarea {
      min-height: 80px;
      resize: vertical;
    }

    .category-select-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .btn-compact {
      padding: 8px 12px;
      font-size: 12px;
      letter-spacing: 0.08em;
    }

    .category-preview {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .category-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid transparent;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
      font-size: 13px;
      letter-spacing: 0.02em;
    }

    .category-chip:hover,
    .category-chip:focus-visible {
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.28);
      background: rgba(255, 255, 255, 0.12);
      outline: none;
    }

    .category-chip[aria-pressed="true"] {
      border-color: rgba(255, 255, 255, 0.45);
      background: rgba(255, 255, 255, 0.18);
    }

    .category-chip-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.2);
    }

    .hidden {
      display: none !important;
    }

    .color-swatch-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .color-swatch {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid transparent;
      background: var(--swatch-color);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
      padding: 0;
      appearance: none;
    }

    .color-swatch:hover,
    .color-swatch:focus-visible {
      transform: scale(1.05);
      outline: none;
    }

    .color-swatch[aria-pressed="true"] {
      border-color: rgba(255, 255, 255, 0.85);
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.25);
    }

    .checkbox-row {
      display: flex;
      align-items: center;
    }

    .checkbox-control {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--text);
      text-transform: none;
      letter-spacing: 0;
    }

    .checkbox-control input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .modal-actions .spacer {
      flex: 1;
    }

    .empty-state {
      color: var(--muted);
      font-size: 13px;
    }

  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div>
        <h1>Focus Flow Calendar</h1>
        <p class="tagline">Design a bold rhythm for your week. Sequence deep work, creative sprints, and essential tasks with intent.</p>
      </div>
      <div class="time-block">
        <span class="current-date"></span>
        <span class="current-time"></span>
      </div>
    </header>

    <section class="controls">
      <div class="control-buttons">
        <button class="btn btn-ghost" id="reset-calendar" title="Reset to today">Today</button>
        <button class="btn btn-primary" id="add-focus">+ Focus Block</button>
      </div>
    </section>

    <section class="calendar-layout">
      <section class="calendar-card main-calendar">
        <div class="calendar-toolbar">
          <button type="button" class="btn btn-ghost btn-icon" data-year-nav="-1" aria-label="Previous year">&larr;</button>
          <span class="year-label" data-year-label></span>
          <button type="button" class="btn btn-ghost btn-icon" data-year-nav="1" aria-label="Next year">&rarr;</button>
        </div>
        <div class="calendar-scroll" id="calendar-grid"></div>
      </section>

      <aside class="calendar-card year-view-card">
        <div class="calendar-toolbar">
          <button type="button" class="btn btn-ghost btn-icon" data-year-nav="-1" aria-label="Previous year">&larr;</button>
          <span class="year-label" data-year-label></span>
          <button type="button" class="btn btn-ghost btn-icon" data-year-nav="1" aria-label="Next year">&rarr;</button>
        </div>
        <div class="year-view-scroll" id="year-view"></div>
      </aside>
    </section>
  </div>

  <div class="modal-backdrop" id="task-modal">
    <div class="modal">
      <h2 id="task-modal-title">Plan a task</h2>
      <form id="task-form">
        <div class="field">
          <label for="task-title">Task</label>
          <input type="text" id="task-title" name="title" placeholder="What will you tackle?" required>
        </div>
        <div class="field">
          <label for="task-category">Category</label>
          <div class="category-select-group">
            <select id="task-category" name="category"></select>
            <button type="button" class="btn btn-ghost btn-compact" id="delete-category">Delete category</button>
          </div>
          <div class="category-preview" id="category-preview"></div>
        </div>
        <div class="field hidden" id="new-category-name-field">
          <label for="new-category-name">New category</label>
          <input type="text" id="new-category-name" name="newCategoryName" placeholder="Category name">
        </div>
        <div class="field hidden" id="new-category-color-field">
          <label>Base colour</label>
          <div class="color-swatch-row" id="category-color-options"></div>
          <input type="hidden" id="new-category-color" name="newCategoryColor">
        </div>
        <div class="field">
          <label for="task-start">Start time</label>
          <input type="time" id="task-start" name="start" placeholder="09:00" step="900">
        </div>
        <div class="field">
          <label for="task-duration">Time allocation (hours)</label>
          <input type="number" min="0" step="0.5" id="task-duration" name="duration" placeholder="2">
        </div>
        <div class="checkbox-row">
          <label class="checkbox-control">
            <input type="checkbox" id="task-mission-critical" name="missionCritical">
            <span>Mission critical</span>
          </label>
        </div>
        <div class="field">
          <label for="task-notes">Notes</label>
          <textarea id="task-notes" name="notes" placeholder="Context, deliverables or links..."></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="task-cancel">Cancel</button>
          <span class="spacer"></span>
          <button type="button" class="btn btn-ghost" id="task-delete" style="display:none;">Delete</button>
          <button type="submit" class="btn btn-primary">Save Task</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" id="focus-modal">
    <div class="modal">
      <h2 id="focus-modal-title">New focus block</h2>
      <form id="focus-form">
        <div class="field">
          <label for="focus-name">Project / Intention</label>
          <input type="text" id="focus-name" name="name" placeholder="Filming + editing ads" required>
        </div>
        <div class="field">
          <label for="focus-start">Start date</label>
          <input type="date" id="focus-start" name="start" required>
        </div>
        <div class="field">
          <label for="focus-end">Wrap date</label>
          <input type="date" id="focus-end" name="end" required>
        </div>
        <div class="field">
          <label for="focus-color">Colour</label>
          <input type="color" id="focus-color" name="color" value="#ff6f91">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-ghost" id="focus-cancel">Cancel</button>
          <span class="spacer"></span>
          <button type="button" class="btn btn-ghost" id="focus-delete" style="display:none;">Delete</button>
          <button type="submit" class="btn btn-primary">Save Focus</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const storageKey = 'focus-flow-calendar-state-v2';
    const legacyStorageKey = 'focus-flow-calendar-state-v1';
    const categoryPalette = [
      '#FF6F91',
      '#FF9671',
      '#FFC75F',
      '#F9F871',
      '#7AD3FF',
      '#6A5ACD',
      '#4CAF50',
      '#F45D01',
      '#FF5F7E',
      '#50B5FF'
    ];

    function defaultCategories() {
      return [
        { id: 1, name: 'General', color: '#6A5ACD' },
        { id: 2, name: 'Deep Work', color: '#FF6F91' },
        { id: 3, name: 'Admin', color: '#FFC75F' }
      ];
    }

    const defaultState = () => {
      const categories = defaultCategories().map((cat) => ({ ...cat }));
      return {
        tasks: {},
        projects: [],
        categories,
        nextTaskId: 1,
        nextProjectId: 1,
        nextCategoryId: categories.length + 1
      };
    };

    function loadState() {
      try {
        let raw = localStorage.getItem(storageKey);
        let migratedFromLegacy = false;
        if (!raw) {
          raw = localStorage.getItem(legacyStorageKey);
          migratedFromLegacy = Boolean(raw);
        }
        if (!raw) return defaultState();
        const parsed = JSON.parse(raw);
        if (!parsed.tasks || typeof parsed.tasks !== 'object') parsed.tasks = {};
        if (!Array.isArray(parsed.projects)) parsed.projects = [];
        if (!Array.isArray(parsed.categories)) {
          parsed.categories = defaultCategories().map((cat) => ({ ...cat }));
        }
        if (!parsed.nextTaskId) parsed.nextTaskId = 1;
        if (!parsed.nextProjectId) parsed.nextProjectId = 1;
        if (!parsed.nextCategoryId) {
          const maxId = parsed.categories.reduce((max, cat) => Math.max(max, Number(cat.id) || 0), 0);
          parsed.nextCategoryId = maxId + 1;
        }
        migrateTaskData(parsed);
        if (migratedFromLegacy) {
          try {
            localStorage.removeItem(legacyStorageKey);
            localStorage.setItem(storageKey, JSON.stringify(parsed));
          } catch (saveErr) {
            console.warn('Unable to persist migrated data', saveErr);
          }
        }
        return parsed;
      } catch (err) {
        console.error('Failed to parse state', err);
        return defaultState();
      }
    }

    function pickCategoryColor(state, fallback) {
      if (fallback) return fallback;
      const used = new Set(
        state.categories
          .map((cat) => (typeof cat.color === 'string' ? cat.color.toLowerCase() : null))
          .filter(Boolean)
      );
      for (const color of categoryPalette) {
        if (!used.has(color.toLowerCase())) return color;
      }
      return categoryPalette[state.categories.length % categoryPalette.length];
    }

    function migrateTaskData(state) {
      const categoriesByName = new Map();
      state.categories = state.categories.map((category, index) => {
        const name = (category.name || '').trim() || `Category ${index + 1}`;
        const id = Number(category.id) || state.nextCategoryId++;
        const normalized = { id, name, color: category.color || categoryPalette[index % categoryPalette.length] };
        categoriesByName.set(name.toLowerCase(), normalized);
        return normalized;
      });

      const ensureCategory = (name, colorHint) => {
        const key = name.toLowerCase();
        if (categoriesByName.has(key)) return categoriesByName.get(key);
        const category = {
          id: state.nextCategoryId++,
          name,
          color: pickCategoryColor(state, colorHint)
        };
        state.categories.push(category);
        categoriesByName.set(key, category);
        return category;
      };

      const generalCategory = ensureCategory('General', '#6A5ACD');

      Object.keys(state.tasks).forEach((dateKey) => {
        const tasks = Array.isArray(state.tasks[dateKey]) ? state.tasks[dateKey] : [];
        tasks.forEach((task) => {
          if (!task || typeof task !== 'object') return;
          task.title = (task.title || '').trim();
          if (!task.title) task.title = 'Untitled task';

          if (task.priority === 'high' && !task.missionCritical) {
            task.missionCritical = true;
          }
          delete task.priority;

          let categoryName = (task.category || '').trim();
          if (!categoryName) {
            categoryName = generalCategory.name;
          }
          const category = ensureCategory(categoryName, task.color);
          task.category = category.name;

          if (task.start && typeof task.start === 'string') {
            task.start = task.start.trim();
          }
          if (!task.start) {
            delete task.start;
          }

          if (task.duration !== undefined && task.duration !== null && task.duration !== '') {
            const numericDuration = Number(task.duration);
            if (!Number.isNaN(numericDuration) && numericDuration >= 0) {
              task.duration = numericDuration;
            } else {
              delete task.duration;
            }
          } else {
            delete task.duration;
          }

          if (typeof task.notes === 'string') {
            task.notes = task.notes.trim();
            if (!task.notes) delete task.notes;
          }

          if (task.color && !category.color) {
            category.color = task.color;
          }
          delete task.color;

          task.missionCritical = Boolean(task.missionCritical);
        });
        state.tasks[dateKey] = tasks.filter(Boolean).sort(compareTasks);
        if (state.tasks[dateKey].length === 0) {
          delete state.tasks[dateKey];
        }
      });

      state.categories.sort((a, b) => a.name.localeCompare(b.name));
    }

    function saveState() {
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    function formatDateKey(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseDateKey(key) {
      const [year, month, day] = key.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function formatFullDate(date) {
      return date.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
    }

    function formatTime(date) {
      return date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    }

    function compareTasks(a, b) {
      const timeA = a.start || '';
      const timeB = b.start || '';
      const hasTimeA = Boolean(timeA);
      const hasTimeB = Boolean(timeB);
      if (!hasTimeA && hasTimeB) return -1;
      if (hasTimeA && !hasTimeB) return 1;
      if (hasTimeA && hasTimeB && timeA !== timeB) {
        return timeA.localeCompare(timeB);
      }
      if (a.missionCritical && !b.missionCritical) return -1;
      if (!a.missionCritical && b.missionCritical) return 1;
      const durationA = Number(a.duration) || 0;
      const durationB = Number(b.duration) || 0;
      if (durationA !== durationB) return durationB - durationA;
      return a.title.localeCompare(b.title);
    }

    function hexToRgba(hex, alpha) {
      if (!hex || typeof hex !== 'string') return `rgba(255,255,255,${alpha})`;
      const stripped = hex.replace('#', '');
      const bigint = parseInt(stripped.length === 3
        ? stripped.split('').map((c) => c + c).join('')
        : stripped, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function hexToRgb(hex) {
      if (!hex || typeof hex !== 'string') return null;
      const stripped = hex.replace('#', '');
      const normalized = stripped.length === 3
        ? stripped.split('').map((c) => c + c).join('')
        : stripped;
      if (normalized.length !== 6) return null;
      const bigint = parseInt(normalized, 16);
      if (Number.isNaN(bigint)) return null;
      return {
        r: (bigint >> 16) & 255,
        g: (bigint >> 8) & 255,
        b: bigint & 255
      };
    }

    function rgbToHex(r, g, b) {
      const toHex = (value) => {
        const clamped = Math.max(0, Math.min(255, Math.round(value)));
        return clamped.toString(16).padStart(2, '0');
      };
      return `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();
    }

    function rgbToHsl(r, g, b) {
      r /= 255;
      g /= 255;
      b /= 255;
      const max = Math.max(r, g, b);
      const min = Math.min(r, g, b);
      let h = 0;
      let s = 0;
      const l = (max + min) / 2;
      if (max !== min) {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r:
            h = (g - b) / d + (g < b ? 6 : 0);
            break;
          case g:
            h = (b - r) / d + 2;
            break;
          case b:
            h = (r - g) / d + 4;
            break;
        }
        h /= 6;
      }
      return { h, s, l };
    }

    function hslToRgb(h, s, l) {
      if (s === 0) {
        const value = l * 255;
        return [value, value, value];
      }
      const hue2rgb = (p, q, t) => {
        if (t < 0) t += 1;
        if (t > 1) t -= 1;
        if (t < 1 / 6) return p + (q - p) * 6 * t;
        if (t < 1 / 2) return q;
        if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
        return p;
      };
      const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
      const p = 2 * l - q;
      const r = hue2rgb(p, q, h + 1 / 3);
      const g = hue2rgb(p, q, h);
      const b = hue2rgb(p, q, h - 1 / 3);
      return [r * 255, g * 255, b * 255];
    }

    function clamp(value, min, max) {
      return Math.min(max, Math.max(min, value));
    }

    function shadeColorByDuration(hex, duration) {
      const rgb = hexToRgb(hex);
      if (!rgb) return '#6A5ACD';
      const { h, s, l } = rgbToHsl(rgb.r, rgb.g, rgb.b);
      const hours = Number(duration) || 0;
      const normalized = clamp(hours / 6, 0, 1);
      const darkening = normalized * 0.3;
      const lightenBoost = hours === 0 ? 0.12 : 0;
      const targetLightness = clamp(l - darkening + lightenBoost, 0.2, 0.78);
      const [nr, ng, nb] = hslToRgb(h, s, targetLightness);
      return rgbToHex(nr, ng, nb);
    }

    const calendarGridEl = document.getElementById('calendar-grid');
    const yearViewEl = document.getElementById('year-view');
    const yearLabels = document.querySelectorAll('[data-year-label]');
    const yearNavButtons = document.querySelectorAll('[data-year-nav]');
    const currentDateEl = document.querySelector('.current-date');
    const currentTimeEl = document.querySelector('.current-time');
    const taskModalBackdrop = document.getElementById('task-modal');
    const taskForm = document.getElementById('task-form');
    const taskModalTitle = document.getElementById('task-modal-title');
    const taskDeleteBtn = document.getElementById('task-delete');
    const taskCancelBtn = document.getElementById('task-cancel');
    const taskCategorySelect = document.getElementById('task-category');
    const newCategoryNameField = document.getElementById('new-category-name-field');
    const newCategoryNameInput = document.getElementById('new-category-name');
    const newCategoryColorField = document.getElementById('new-category-color-field');
    const newCategoryColorInput = document.getElementById('new-category-color');
    const categoryColorOptions = document.getElementById('category-color-options');
    const missionCriticalInput = document.getElementById('task-mission-critical');
    const taskTitleInput = document.getElementById('task-title');
    const taskStartInput = document.getElementById('task-start');
    const taskDurationInput = document.getElementById('task-duration');
    const taskNotesInput = document.getElementById('task-notes');
    const categoryPreviewEl = document.getElementById('category-preview');
    const deleteCategoryBtn = document.getElementById('delete-category');
    if (deleteCategoryBtn) {
      deleteCategoryBtn.disabled = true;
      deleteCategoryBtn.setAttribute('aria-disabled', 'true');
    }

    const focusModalBackdrop = document.getElementById('focus-modal');
    const focusForm = document.getElementById('focus-form');
    const focusModalTitle = document.getElementById('focus-modal-title');
    const focusDeleteBtn = document.getElementById('focus-delete');
    const focusCancelBtn = document.getElementById('focus-cancel');

    renderCategoryColorOptions();
    selectCategoryColor(categoryPalette[0]);

    let state = loadState();
    ensureGeneralCategoryExists();
    let viewDate = new Date();

    let editingTask = null;
    let editingDate = null;
    let editingFocusId = null;
    let draggedTask = null;
    let focusSelection = null;
    let focusSelectionPointerId = null;
    let initialScrollCompleted = false;

    function detachFocusPointerListeners() {
      window.removeEventListener('pointerup', handleFocusPointerUp);
      window.removeEventListener('pointercancel', handleFocusPointerCancel);
    }

    function clearFocusSelectionHighlights() {
      if (calendarGridEl) {
        calendarGridEl.querySelectorAll('.day.focus-range').forEach((cell) => {
          cell.classList.remove('focus-range');
        });
      }
      if (yearViewEl) {
        yearViewEl.querySelectorAll('.mini-day.focus-range').forEach((cell) => {
          cell.classList.remove('focus-range');
        });
      }
    }

    function updateFocusSelectionHighlight() {
      clearFocusSelectionHighlights();
      if (!focusSelection) return;
      const { anchor, current } = focusSelection;
      const [startKey, endKey] = anchor <= current ? [anchor, current] : [current, anchor];
      const startDate = parseDateKey(startKey);
      const endDate = parseDateKey(endKey);
      const cursor = new Date(startDate);
      while (cursor <= endDate) {
        const key = formatDateKey(cursor);
        const cell = calendarGridEl?.querySelector(`.day[data-date="${key}"]`);
        if (cell) {
          cell.classList.add('focus-range');
        }
        const miniCell = yearViewEl?.querySelector(`.mini-day[data-date="${key}"]`);
        if (miniCell) {
          miniCell.classList.add('focus-range');
        }
        cursor.setDate(cursor.getDate() + 1);
      }
    }

    function clearFocusSelection() {
      clearFocusSelectionHighlights();
      focusSelection = null;
      focusSelectionPointerId = null;
      detachFocusPointerListeners();
    }

    function finalizeFocusSelection() {
      if (!focusSelection) return;
      const { anchor, current } = focusSelection;
      const [startKey, endKey] = anchor <= current ? [anchor, current] : [current, anchor];
      clearFocusSelection();
      openFocusModal(null, { start: startKey, end: endKey });
    }

    function handleFocusPointerUp(event) {
      if (!focusSelection) {
        detachFocusPointerListeners();
        return;
      }
      if (focusSelectionPointerId != null && event.pointerId !== focusSelectionPointerId) {
        return;
      }
      finalizeFocusSelection();
    }

    function handleFocusPointerCancel() {
      clearFocusSelection();
    }

    function startFocusSelection(dateKey, pointerId) {
      clearFocusSelection();
      focusSelection = { anchor: dateKey, current: dateKey };
      focusSelectionPointerId = pointerId;
      updateFocusSelectionHighlight();
      window.addEventListener('pointerup', handleFocusPointerUp);
      window.addEventListener('pointercancel', handleFocusPointerCancel);
    }

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && focusSelection) {
        clearFocusSelection();
      }
    });

    function clearDragState() {
      draggedTask = null;
      document.querySelectorAll('.drag-over').forEach((day) => day.classList.remove('drag-over'));
      document.querySelectorAll('.task-card.is-dragging').forEach((card) => card.classList.remove('is-dragging'));
    }

    function renderCategoryColorOptions() {
      if (!categoryColorOptions) return;
      categoryColorOptions.innerHTML = '';
      categoryPalette.forEach((color) => {
        const swatch = document.createElement('button');
        swatch.type = 'button';
        swatch.className = 'color-swatch';
        swatch.style.setProperty('--swatch-color', color);
        swatch.dataset.color = color;
        swatch.setAttribute('aria-pressed', 'false');
        swatch.title = color;
        swatch.addEventListener('click', () => selectCategoryColor(color));
        swatch.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            selectCategoryColor(color);
          }
        });
        categoryColorOptions.appendChild(swatch);
      });
    }

    function selectCategoryColor(color) {
      if (!newCategoryColorInput) return;
      newCategoryColorInput.value = color;
      if (!categoryColorOptions) return;
      categoryColorOptions.querySelectorAll('.color-swatch').forEach((swatch) => {
        swatch.setAttribute('aria-pressed', swatch.dataset.color === color ? 'true' : 'false');
      });
    }

    function toggleNewCategoryFields(show) {
      newCategoryNameField.classList.toggle('hidden', !show);
      newCategoryColorField.classList.toggle('hidden', !show);
      if (show) {
        if (!newCategoryColorInput.value) {
          selectCategoryColor(categoryPalette[0]);
        } else {
          selectCategoryColor(newCategoryColorInput.value);
        }
        newCategoryNameInput.focus();
      } else {
        newCategoryNameInput.value = '';
        newCategoryColorInput.value = '';
        categoryColorOptions.querySelectorAll('.color-swatch').forEach((swatch) => {
          swatch.setAttribute('aria-pressed', 'false');
        });
      }
    }

    function getCategoryByName(name) {
      if (!name || !Array.isArray(state.categories)) return null;
      const target = name.toLowerCase();
      return state.categories.find((category) => category.name.toLowerCase() === target) || null;
    }

    function ensureGeneralCategoryExists() {
      let general = getCategoryByName('General');
      if (!general) {
        general = { id: state.nextCategoryId++, name: 'General', color: '#6A5ACD' };
        state.categories.push(general);
      }
      return general;
    }

    function getSortedCategories() {
      ensureGeneralCategoryExists();
      return state.categories
        .slice()
        .sort((a, b) => {
          if (a.name === 'General') return -1;
          if (b.name === 'General') return 1;
          return a.name.localeCompare(b.name);
        });
    }

    function renderCategoryPreview(categories, selectedValue) {
      if (!categoryPreviewEl) return;
      categoryPreviewEl.innerHTML = '';
      const showPreview = selectedValue && selectedValue !== '__new__';
      categoryPreviewEl.classList.toggle('hidden', !showPreview);
      if (!showPreview) return;

      categories.forEach((category) => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'category-chip';
        chip.dataset.category = category.name;
        chip.setAttribute('aria-pressed', category.name === selectedValue ? 'true' : 'false');

        const dot = document.createElement('span');
        dot.className = 'category-chip-dot';
        dot.style.background = category.color;
        chip.appendChild(dot);
        chip.append(category.name);

        chip.addEventListener('click', () => {
          taskCategorySelect.value = category.name;
          updateCategoryPreviewSelection(category.name);
          toggleNewCategoryFields(false);
          updateDeleteCategoryButtonState(category.name);
        });

        chip.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            taskCategorySelect.value = category.name;
            updateCategoryPreviewSelection(category.name);
            toggleNewCategoryFields(false);
            updateDeleteCategoryButtonState(category.name);
          }
        });

        categoryPreviewEl.appendChild(chip);
      });
    }

    function updateCategoryPreviewSelection(value) {
      if (!categoryPreviewEl) return;
      categoryPreviewEl.querySelectorAll('.category-chip').forEach((chip) => {
        chip.setAttribute('aria-pressed', chip.dataset.category === value ? 'true' : 'false');
      });
    }

    function updateDeleteCategoryButtonState(selectedValue) {
      if (!deleteCategoryBtn) return;
      const disabled = !selectedValue || selectedValue === '__new__' || selectedValue.toLowerCase() === 'general';
      deleteCategoryBtn.disabled = disabled;
      deleteCategoryBtn.setAttribute('aria-disabled', String(disabled));
    }

    function populateCategorySelect(selectedName, forceNew = false) {
      const sorted = getSortedCategories();

      taskCategorySelect.innerHTML = '';
      sorted.forEach((category) => {
        const option = document.createElement('option');
        option.value = category.name;
        option.textContent = category.name;
        taskCategorySelect.appendChild(option);
      });

      const newOption = document.createElement('option');
      newOption.value = '__new__';
      newOption.textContent = 'Add new category…';
      taskCategorySelect.appendChild(newOption);

      let nextValue;
      if (forceNew) {
        nextValue = '__new__';
      } else if (selectedName) {
        const match = sorted.find((category) => category.name === selectedName);
        nextValue = match ? match.name : (sorted[0]?.name || '__new__');
      } else {
        nextValue = sorted[0] ? sorted[0].name : '__new__';
      }

      taskCategorySelect.value = nextValue;
      toggleNewCategoryFields(nextValue === '__new__');
      renderCategoryPreview(sorted, nextValue);
      updateDeleteCategoryButtonState(nextValue);
    }

    function openTaskModal(dateKey, task) {
      editingDate = dateKey;
      editingTask = task ? { ...task } : null;
      taskModalBackdrop.classList.add('open');
      taskModalTitle.textContent = task ? 'Update task' : 'Plan a task';
      taskDeleteBtn.style.display = task ? 'inline-flex' : 'none';

      taskForm.reset();
      missionCriticalInput.checked = Boolean(task?.missionCritical);
      taskTitleInput.value = task?.title || '';
      taskStartInput.value = task?.start || '';
      taskDurationInput.value = task?.duration ?? '';
      taskNotesInput.value = task?.notes || '';
      newCategoryNameInput.value = '';
      newCategoryColorInput.value = '';
      populateCategorySelect(task?.category || null);

        if (task && taskCategorySelect.value === '__new__') {
          newCategoryNameInput.value = task.category || '';
          const fallbackColor = getCategoryByName(task.category)?.color || pickCategoryColor(state);
          newCategoryColorInput.value = fallbackColor;
          toggleNewCategoryFields(true);
          selectCategoryColor(fallbackColor);
        }
    }

    function closeTaskModal() {
      taskModalBackdrop.classList.remove('open');
      editingTask = null;
      editingDate = null;
      draggedTask = null;
      missionCriticalInput.checked = false;
      toggleNewCategoryFields(false);
    }

    function openFocusModal(project, options = {}) {
      editingFocusId = project ? project.id : null;
      focusModalBackdrop.classList.add('open');
      focusModalTitle.textContent = project ? 'Update focus block' : 'New focus block';
      focusDeleteBtn.style.display = project ? 'inline-flex' : 'none';

      focusForm.reset();
      const colorField = document.getElementById('focus-color');
      const nameField = document.getElementById('focus-name');
      const startField = document.getElementById('focus-start');
      const endField = document.getElementById('focus-end');

      colorField.value = project?.color || options.color || '#ff6f91';
      if (project) {
        nameField.value = project.name;
        startField.value = project.start;
        endField.value = project.end;
      } else {
        if (options.name) nameField.value = options.name;
        const defaultDate = formatDateKey(new Date());
        const startValue = options.start || defaultDate;
        const endValue = options.end || options.start || defaultDate;
        startField.value = startValue;
        endField.value = endValue;
      }
    }

    function closeFocusModal() {
      focusModalBackdrop.classList.remove('open');
      editingFocusId = null;
    }

    function ensureTasks(dateKey) {
      if (!state.tasks[dateKey]) state.tasks[dateKey] = [];
      return state.tasks[dateKey];
    }

    function removeEmptyTaskLists(dateKey) {
      if (state.tasks[dateKey] && state.tasks[dateKey].length === 0) {
        delete state.tasks[dateKey];
      }
    }

    function createWeekdayRow() {
      const row = document.createElement('div');
      row.className = 'weekday-row';
      const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      labels.forEach((label, index) => {
        const span = document.createElement('span');
        span.textContent = label;
        if (index >= 5) {
          span.classList.add('weekend');
        }
        row.appendChild(span);
      });
      return row;
    }

    function computeCalendarBounds() {
      const anchorYear = viewDate.getFullYear();
      const start = new Date(anchorYear, 0, 1);
      const end = new Date(anchorYear, 11, 31);
      return { start, end };
    }

    function buildMonthSequence() {
      const { start, end } = computeCalendarBounds();
      const cursor = new Date(start);
      cursor.setDate(1);
      const months = [];
      while (cursor <= end) {
        months.push({ year: cursor.getFullYear(), month: cursor.getMonth() });
        cursor.setMonth(cursor.getMonth() + 1);
      }
      return months;
    }

    function updateYearLabels() {
      const year = viewDate.getFullYear();
      yearLabels.forEach((label) => {
        label.textContent = year;
      });
    }

    function createMiniWeekdayRow() {
      const row = document.createElement('div');
      row.className = 'mini-weekday-row';
      const labels = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
      labels.forEach((label) => {
        const span = document.createElement('span');
        span.textContent = label;
        row.appendChild(span);
      });
      return row;
    }

    function renderYearOverview() {
      if (!yearViewEl) return;
      yearViewEl.innerHTML = '';
      const months = buildMonthSequence();
      const realTodayKey = formatDateKey(new Date());

      months.forEach(({ year, month }) => {
        const container = document.createElement('div');
        container.className = 'mini-month';

        const header = document.createElement('div');
        header.className = 'mini-month-header';
        const monthLabel = document.createElement('span');
        const labelDate = new Date(year, month, 1);
        monthLabel.textContent = labelDate.toLocaleDateString(undefined, { month: 'long' });
        const yearLabel = document.createElement('span');
        yearLabel.className = 'mini-year';
        yearLabel.textContent = labelDate.toLocaleDateString(undefined, { year: 'numeric' });
        header.appendChild(monthLabel);
        header.appendChild(yearLabel);
        container.appendChild(header);

        container.appendChild(createMiniWeekdayRow());

        const grid = document.createElement('div');
        grid.className = 'mini-grid';
        container.appendChild(grid);

        const firstDay = new Date(year, month, 1);
        const startWeekday = (firstDay.getDay() + 6) % 7;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const totalCells = Math.ceil((startWeekday + daysInMonth) / 7) * 7;

        for (let i = 0; i < totalCells; i++) {
          const cell = document.createElement('div');
          cell.className = 'mini-day';

          const dayNumber = i - startWeekday + 1;
          if (dayNumber < 1 || dayNumber > daysInMonth) {
            cell.classList.add('empty');
            grid.appendChild(cell);
            continue;
          }

          const date = new Date(year, month, dayNumber);
          const dateKey = formatDateKey(date);
          cell.dataset.date = dateKey;
          const weekday = date.getDay();
          if (weekday === 0 || weekday === 6) {
            cell.classList.add('weekend');
          }
          if (dateKey === realTodayKey) {
            cell.classList.add('today');
          }

          const number = document.createElement('span');
          number.className = 'mini-day-number';
          number.textContent = dayNumber;
          cell.appendChild(number);

          const activeProjects = state.projects.filter((project) => project.start <= dateKey && project.end >= dateKey);
          if (activeProjects.length) {
            const stack = document.createElement('div');
            stack.className = 'mini-focus-stack';
            activeProjects.forEach((project) => {
              const block = document.createElement('button');
              block.type = 'button';
              block.className = 'mini-focus-block';
              block.style.setProperty('--mini-focus-strong', hexToRgba(project.color, 0.45));
              block.style.setProperty('--mini-focus-soft', hexToRgba(project.color, 0.12));
              block.style.setProperty('--mini-focus-border', hexToRgba(project.color, 0.6));
              block.title = project.name;
              block.setAttribute('aria-label', project.name);
              block.addEventListener('click', (event) => {
                event.stopPropagation();
                if (event.shiftKey) return;
                openFocusModal(project);
              });
              block.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                  event.preventDefault();
                  openFocusModal(project);
                }
              });
              stack.appendChild(block);
            });
            cell.appendChild(stack);
          }

          cell.addEventListener('pointerdown', (event) => {
            if (event.button !== 0 || !event.shiftKey) return;
            event.preventDefault();
            startFocusSelection(dateKey, event.pointerId);
          });

          cell.addEventListener('pointerenter', () => {
            if (!focusSelection) return;
            focusSelection.current = dateKey;
            updateFocusSelectionHighlight();
          });

          grid.appendChild(cell);
        }

        yearViewEl.appendChild(container);
      });
    }

    function getTaskTimeRange(task) {
      if (!task || !task.start) return '';
      const endTime = task.duration ? computeEndTime(task.start, task.duration) : null;
      return endTime ? `${task.start} - ${endTime}` : task.start;
    }


    function setupFlyoutHover(cell, flyout) {
      if (!cell || !flyout) return;
      let hideTimeout;

      const show = () => {
        clearTimeout(hideTimeout);
        cell.classList.add('show-flyout');
      };

      const hide = () => {
        cell.classList.remove('show-flyout');
      };

      const scheduleHide = (event) => {
        const related = event?.relatedTarget;
        if (related && (cell.contains(related) || flyout.contains(related))) {
          return;
        }
        clearTimeout(hideTimeout);
        hideTimeout = setTimeout(hide, 140);
      };

      cell.addEventListener('mouseenter', show);
      cell.addEventListener('mouseleave', scheduleHide);
      flyout.addEventListener('mouseenter', show);
      flyout.addEventListener('mouseleave', scheduleHide);
    }

    function scrollToToday({ smooth = true } = {}) {
      if (!calendarGridEl) return;
      const todayCell = calendarGridEl.querySelector('.day.today');
      if (!todayCell) return;
      todayCell.scrollIntoView({ behavior: smooth ? 'smooth' : 'auto', block: 'center' });
    }

    function renderCalendar() {
      clearDragState();
      if (!calendarGridEl) return;

      calendarGridEl.innerHTML = '';
      const months = buildMonthSequence();
      const realTodayKey = formatDateKey(new Date());

      months.forEach(({ year, month }) => {
        const monthBlock = document.createElement('div');
        monthBlock.className = 'month-block';

        const labelDate = new Date(year, month, 1);
        const labelText = labelDate.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });

        const divider = document.createElement('div');
        divider.className = 'month-divider';
        const overlayLabel = document.createElement('span');
        overlayLabel.className = 'month-label';
        overlayLabel.textContent = labelText;
        divider.appendChild(overlayLabel);
        const tag = document.createElement('span');
        tag.className = 'month-tag';
        tag.textContent = labelText;
        divider.appendChild(tag);

        monthBlock.appendChild(divider);
        monthBlock.appendChild(createWeekdayRow());

        const monthGrid = document.createElement('div');
        monthGrid.className = 'calendar-grid';
        monthBlock.appendChild(monthGrid);

        const firstDay = new Date(year, month, 1);
        const startWeekday = (firstDay.getDay() + 6) % 7;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const totalCells = Math.ceil((startWeekday + daysInMonth) / 7) * 7;

        for (let i = 0; i < totalCells; i++) {
          const cell = document.createElement('div');
          cell.className = 'day';

          const dayNumber = i - startWeekday + 1;
          if (dayNumber < 1 || dayNumber > daysInMonth) {
            cell.classList.add('empty');
            monthGrid.appendChild(cell);
            continue;
          }

          const date = new Date(year, month, dayNumber);
          const dateKey = formatDateKey(date);
          cell.dataset.date = dateKey;

          const weekday = date.getDay();
          if (weekday === 0 || weekday === 6) {
            cell.classList.add('weekend');
          }

          if (realTodayKey === dateKey) {
            cell.classList.add('today');
          }

          cell.addEventListener('pointerdown', (event) => {
            if (event.button !== 0 || !event.shiftKey) return;
            if (event.target.closest('.task-card') || event.target.closest('.task-flyout') || event.target.closest('.add-task-btn') || event.target.closest('.focus-badge')) {
              return;
            }
            event.preventDefault();
            startFocusSelection(dateKey, event.pointerId);
          });

          cell.addEventListener('pointerenter', () => {
            if (!focusSelection) return;
            focusSelection.current = dateKey;
            updateFocusSelectionHighlight();
          });

          cell.addEventListener('dragenter', (event) => {
            event.preventDefault();
            cell.classList.add('drag-over');
          });

          cell.addEventListener('dragover', (event) => {
            event.preventDefault();
            cell.classList.add('drag-over');
            event.dataTransfer.dropEffect = 'move';
          });

          cell.addEventListener('dragleave', () => {
            cell.classList.remove('drag-over');
          });

          cell.addEventListener('drop', () => {
            cell.classList.remove('drag-over');
            if (!draggedTask) {
              clearDragState();
              return;
            }
            moveTaskToDate(draggedTask, dateKey);
            clearDragState();
          });

          const header = document.createElement('div');
          header.className = 'day-header';
          const numberEl = document.createElement('div');
          numberEl.className = 'day-number';
          numberEl.textContent = dayNumber;
          header.appendChild(numberEl);

          const addBtn = document.createElement('button');
          addBtn.className = 'add-task-btn';
          addBtn.type = 'button';
          addBtn.textContent = '+';
          addBtn.title = 'Add task';
          addBtn.addEventListener('click', () => openTaskModal(dateKey));
          header.appendChild(addBtn);

          cell.appendChild(header);

          const overlayStack = document.createElement('div');
          overlayStack.className = 'focus-overlay-stack';
          const focusBadges = document.createElement('div');
          focusBadges.className = 'focus-badges';

          const activeProjects = state.projects.filter((project) => project.start <= dateKey && project.end >= dateKey);
          activeProjects.forEach((project) => {
            const overlay = document.createElement('div');
            overlay.className = 'focus-overlay';
            overlay.style.background = hexToRgba(project.color, 0.18);
            overlayStack.appendChild(overlay);

            const badge = document.createElement('button');
            badge.type = 'button';
            badge.className = 'focus-badge';
            const dot = document.createElement('span');
            dot.className = 'focus-badge-dot';
            dot.style.background = project.color;
            badge.appendChild(dot);
            const label = document.createElement('span');
            label.textContent = project.name;
            badge.appendChild(label);
            badge.addEventListener('click', (event) => {
              event.stopPropagation();
              openFocusModal(project);
            });
            badge.addEventListener('keydown', (event) => {
              if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                openFocusModal(project);
              }
            });
            focusBadges.appendChild(badge);
          });

          if (activeProjects.length > 0) {
            focusBadges.classList.add('active');
          }

          cell.appendChild(overlayStack);

          const taskList = document.createElement('div');
          taskList.className = 'task-list';
          const preview = document.createElement('div');
          preview.className = 'task-preview';

          const tasks = (state.tasks[dateKey] || []).slice().sort(compareTasks);
          tasks.forEach((task) => {
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card';
            taskCard.draggable = true;
            taskCard.dataset.taskId = task.id;

            const category = getCategoryByName(task.category) || ensureGeneralCategoryExists();
            const baseColor = category?.color || '#6A5ACD';
            const shadeColor = shadeColorByDuration(baseColor, task.duration);

            const previewBar = document.createElement('div');
            previewBar.className = 'task-preview-bar';
            previewBar.style.background = hexToRgba(shadeColor, 0.85);
            preview.appendChild(previewBar);

            const tintStrong = hexToRgba(shadeColor, 0.38);
            const tintSoft = hexToRgba(shadeColor, 0.14);
            const outlineColor = task.missionCritical ? 'rgba(255, 196, 0, 0.85)' : hexToRgba(shadeColor, 0.55);
            taskCard.style.setProperty('--task-tint-strong', tintStrong);
            taskCard.style.setProperty('--task-tint-soft', tintSoft);
            taskCard.style.setProperty('--task-outline', outlineColor);
            taskCard.style.setProperty('--task-dot', shadeColor);

            if (task.missionCritical) {
              taskCard.classList.add('mission-critical');
              previewBar.classList.add('mission-critical');
            }

            taskCard.addEventListener('dragstart', (event) => {
              draggedTask = { id: task.id, fromDate: dateKey };
              event.dataTransfer.effectAllowed = 'move';
              event.dataTransfer.setData('text/plain', String(task.id));
              taskCard.classList.add('is-dragging');
            });

            taskCard.addEventListener('dragend', () => {
              clearDragState();
            });

            taskCard.addEventListener('dblclick', () => {
              openTaskModal(dateKey, task);
            });

            const title = document.createElement('div');
            title.className = 'task-title';

            const colorDot = document.createElement('span');
            colorDot.className = 'task-dot';
            colorDot.style.background = shadeColor;
            title.appendChild(colorDot);

            const name = document.createElement('span');
            name.className = 'task-name';
            name.textContent = task.title;
            title.appendChild(name);

            const timeRange = getTaskTimeRange(task);
            if (timeRange) {
              const timeEl = document.createElement('span');
              timeEl.className = 'task-time';
              timeEl.textContent = timeRange;
              title.appendChild(timeEl);
            }

            taskCard.appendChild(title);

            const meta = document.createElement('div');
            meta.className = 'task-meta';
            const detailRow = document.createElement('div');
            detailRow.className = 'task-detail-row';

            if (category) {
              const categoryDetail = document.createElement('span');
              categoryDetail.className = 'task-detail';
              categoryDetail.textContent = category.name;
              detailRow.appendChild(categoryDetail);
            }

            const durationValue = Number(task.duration);
            if (!Number.isNaN(durationValue) && durationValue > 0) {
              const durationDetail = document.createElement('span');
              durationDetail.className = 'task-detail';
              const formatted = Number.isInteger(durationValue) ? `${durationValue}h` : `${durationValue.toFixed(1)}h`;
              durationDetail.textContent = `Duration ${formatted}`;
              detailRow.appendChild(durationDetail);
            }

            if (task.missionCritical) {
              const missionDetail = document.createElement('span');
              missionDetail.className = 'task-detail mission-critical';
              missionDetail.textContent = 'Mission critical';
              detailRow.appendChild(missionDetail);
            }

            if (detailRow.children.length) {
              meta.appendChild(detailRow);
            }

            if (task.notes) {
              const firstLine = task.notes.split(/\r?\n/)[0].trim();
              if (firstLine) {
                const notesLine = document.createElement('div');
                notesLine.className = 'task-note-line';
                notesLine.textContent = firstLine;
                meta.appendChild(notesLine);
              }
            }

            if (meta.children.length) {
              taskCard.appendChild(meta);
            }

            taskList.appendChild(taskCard);
          });

          if (!tasks.length) {
            const previewEmpty = document.createElement('div');
            previewEmpty.className = 'task-preview-empty';
            previewEmpty.textContent = 'No tasks yet';
            preview.appendChild(previewEmpty);

            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.textContent = 'Drop tasks here';
            taskList.appendChild(empty);
          }

          const flyout = document.createElement('div');
          flyout.className = 'task-flyout';
          if (activeProjects.length > 0) {
            flyout.appendChild(focusBadges);
          }
          flyout.appendChild(taskList);

          cell.appendChild(preview);
          cell.appendChild(flyout);

          if (realTodayKey === dateKey) {
            const progress = document.createElement('div');
            progress.className = 'day-progress';
            cell.appendChild(progress);
          }

          monthGrid.appendChild(cell);
          setupFlyoutHover(cell, flyout);
        }

        calendarGridEl.appendChild(monthBlock);
      });

      renderYearOverview();
      updateYearLabels();

      updateCurrentTime();
      updateFocusSelectionHighlight();

      if (!initialScrollCompleted) {
        initialScrollCompleted = true;
        if (new Date().getFullYear() === viewDate.getFullYear()) {
          setTimeout(() => scrollToToday(), 150);
        }
      }
    }

    function computeEndTime(start, duration) {
      const [hours, minutes] = start.split(':').map(Number);
      const totalMinutes = hours * 60 + minutes + Math.round(Number(duration || 0) * 60);
      const endHours = Math.floor(totalMinutes / 60) % 24;
      const endMinutes = totalMinutes % 60;
      return `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
    }

    function moveTaskToDate(taskInfo, newDateKey) {
      const fromTasks = state.tasks[taskInfo.fromDate] || [];
      const taskIndex = fromTasks.findIndex((t) => t.id === taskInfo.id);
      if (taskIndex === -1) return;

      const [task] = fromTasks.splice(taskIndex, 1);
      if (!state.tasks[newDateKey]) state.tasks[newDateKey] = [];
      state.tasks[newDateKey].push(task);

      if (fromTasks.length === 0) {
        delete state.tasks[taskInfo.fromDate];
      }

      state.tasks[newDateKey].sort(compareTasks);
      saveState();
      renderCalendar();
    }

    document.getElementById('reset-calendar').addEventListener('click', () => {
      viewDate = new Date();
      initialScrollCompleted = false;
      renderCalendar();
    });

    yearNavButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const delta = Number(button.dataset.yearNav);
        if (Number.isNaN(delta)) return;
        const targetYear = viewDate.getFullYear() + delta;
        viewDate = new Date(targetYear, 0, 1);
        renderCalendar();
      });
    });

    document.getElementById('add-focus').addEventListener('click', () => {
      openFocusModal(null);
    });

    taskCancelBtn.addEventListener('click', closeTaskModal);
    taskCategorySelect.addEventListener('change', () => {
      const value = taskCategorySelect.value;
      const isNew = value === '__new__';
      toggleNewCategoryFields(isNew);
      if (!isNew) {
        newCategoryNameInput.value = '';
        newCategoryColorInput.value = '';
      }
      renderCategoryPreview(getSortedCategories(), value);
      updateDeleteCategoryButtonState(value);
    });

    if (deleteCategoryBtn) {
      deleteCategoryBtn.addEventListener('click', () => {
        const selectedValue = taskCategorySelect.value;
        if (!selectedValue || selectedValue === '__new__' || selectedValue.toLowerCase() === 'general') {
          return;
        }
        if (!window.confirm(`Delete the "${selectedValue}" category? All tasks will be reassigned to General.`)) {
          return;
        }
        const index = state.categories.findIndex((category) => category.name === selectedValue);
        if (index === -1) return;
        const general = ensureGeneralCategoryExists();
        state.categories.splice(index, 1);
        Object.keys(state.tasks).forEach((dateKey) => {
          const tasks = state.tasks[dateKey];
          if (!Array.isArray(tasks)) return;
          tasks.forEach((task) => {
            if (task.category === selectedValue) {
              task.category = general.name;
            }
          });
        });
        populateCategorySelect(general.name);
        saveState();
        renderCalendar();
      });
    }

    focusCancelBtn.addEventListener('click', closeFocusModal);

    taskModalBackdrop.addEventListener('click', (event) => {
      if (event.target === taskModalBackdrop) {
        closeTaskModal();
      }
    });

    focusModalBackdrop.addEventListener('click', (event) => {
      if (event.target === focusModalBackdrop) {
        closeFocusModal();
      }
    });

    taskForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const formData = new FormData(taskForm);
      const title = formData.get('title').trim();
      if (!title) return;

      let categorySelection = formData.get('category');
      const isNewCategory = categorySelection === '__new__';
      let categoryName = isNewCategory ? (formData.get('newCategoryName') || '').trim() : (categorySelection || '').trim();

      if (isNewCategory) {
        if (!categoryName) {
          alert('Please provide a name for the new category.');
          return;
        }
        const existing = getCategoryByName(categoryName);
        if (existing) {
          categoryName = existing.name;
        } else {
          const colorValue = formData.get('newCategoryColor') || categoryPalette[0];
          const newCategory = { id: state.nextCategoryId++, name: categoryName, color: colorValue };
          state.categories.push(newCategory);
        }
      } else if (!categoryName) {
        categoryName = ensureGeneralCategoryExists().name;
      }

      const start = (formData.get('start') || '').trim();
      const durationRaw = formData.get('duration');
      const durationValue = durationRaw !== null && durationRaw !== '' ? Number(durationRaw) : null;
      if (durationValue != null && (Number.isNaN(durationValue) || durationValue < 0)) {
        alert('Please provide a valid duration.');
        return;
      }
      const notes = (formData.get('notes') || '').trim();

      const payload = {
        title,
        category: categoryName,
        missionCritical: Boolean(missionCriticalInput.checked)
      };

      if (start) payload.start = start;
      if (durationValue != null) payload.duration = durationValue;
      if (notes) payload.notes = notes;

      if (editingTask) {
        const tasks = ensureTasks(editingDate);
        const index = tasks.findIndex((task) => task.id === editingTask.id);
        if (index !== -1) {
          tasks[index] = { ...tasks[index], ...payload };
        }
      } else {
        const taskId = state.nextTaskId++;
        ensureTasks(editingDate).push({ id: taskId, ...payload });
      }

      ensureTasks(editingDate).sort(compareTasks);
      saveState();
      closeTaskModal();
      renderCalendar();
    });

    taskDeleteBtn.addEventListener('click', () => {
      if (!editingTask) return;
      const tasks = ensureTasks(editingDate);
      const index = tasks.findIndex((task) => task.id === editingTask.id);
      if (index !== -1) {
        tasks.splice(index, 1);
      }
      removeEmptyTaskLists(editingDate);
      saveState();
      closeTaskModal();
      renderCalendar();
    });

    focusForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const formData = new FormData(focusForm);
      const name = formData.get('name').trim();
      const start = formData.get('start');
      const end = formData.get('end');
      if (!name || !start || !end) return;

      if (end < start) {
        alert('The wrap date must be on or after the start date.');
        return;
      }

      const color = formData.get('color');

      if (editingFocusId != null) {
        const index = state.projects.findIndex((project) => project.id === editingFocusId);
        if (index !== -1) {
          state.projects[index] = { ...state.projects[index], name, start, end, color };
        }
      } else {
        const project = {
          id: state.nextProjectId++,
          name,
          start,
          end,
          color
        };
        state.projects.push(project);
      }

      saveState();
      closeFocusModal();
      renderCalendar();
    });

    focusDeleteBtn.addEventListener('click', () => {
      if (editingFocusId == null) return;
      const index = state.projects.findIndex((project) => project.id === editingFocusId);
      if (index !== -1) {
        state.projects.splice(index, 1);
      }
      saveState();
      closeFocusModal();
      renderCalendar();
    });

    function updateCurrentTime() {
      const now = new Date();
      currentDateEl.textContent = formatFullDate(now);
      currentTimeEl.textContent = formatTime(now);

      const todayKey = formatDateKey(now);
      const todayCell = calendarGridEl.querySelector(`.day[data-date="${todayKey}"]`);
      if (todayCell) {
        todayCell.classList.add('today');
        const progress = todayCell.querySelector('.day-progress');
        if (progress) {
          const minutes = now.getHours() * 60 + now.getMinutes();
          const percentage = Math.min(100, Math.max(0, (minutes / (24 * 60)) * 100));
          progress.style.width = `${percentage}%`;
        }
      }
    }

    setInterval(updateCurrentTime, 60 * 1000);

    renderCalendar();
  </script>
</body>
</html>
